# GitHub Actions Workflows

æœ¬ç›®å½•åŒ…å«é¡¹ç›®çš„ CI/CD å·¥ä½œæµé…ç½®ï¼Œä½¿ç”¨ **self-hosted runner** åœ¨ Ubuntu 24.04 æœåŠ¡å™¨ä¸Šè¿è¡Œã€‚

## å·¥ä½œæµæ¦‚è§ˆ

### 1. åŸºç¡€æ„å»ºå’Œæµ‹è¯• (`build.yml`)

**è§¦å‘æ¡ä»¶ï¼š**
- Push åˆ° `main` æˆ– `develop` åˆ†æ”¯
- Pull Request åˆ° `main` æˆ– `develop` åˆ†æ”¯

**æ‰§è¡Œå†…å®¹ï¼š**
- âœ… æ£€å‡ºä»£ç 
- âœ… è®¾ç½® Java 17 ç¯å¢ƒ
- âœ… æ„å»ºæ‰€æœ‰æ¨¡å—ï¼ˆè·³è¿‡æµ‹è¯•ï¼‰
- âœ… è¿è¡Œå•å…ƒæµ‹è¯•ï¼ˆä¸éœ€è¦å¤–éƒ¨æœåŠ¡ï¼‰
- âœ… ä¸Šä¼ æµ‹è¯•ç»“æœå’Œæ„å»ºäº§ç‰©

**è¿è¡Œæ—¶é—´ï¼š** ~5-10 åˆ†é’Ÿ

---

### 2. é›†æˆæµ‹è¯• (`integration-test.yml`)

**è§¦å‘æ¡ä»¶ï¼š**
- Push åˆ° `main` æˆ– `develop` åˆ†æ”¯
- Pull Request åˆ° `main` æˆ– `develop` åˆ†æ”¯
- æ¯å¤©å‡Œæ™¨ 2 ç‚¹è‡ªåŠ¨è¿è¡Œ
- æ‰‹åŠ¨è§¦å‘

**æ‰§è¡Œå†…å®¹ï¼š**
- âœ… æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼ˆRedisã€MySQLã€PostgreSQLï¼‰
- âœ… è‡ªåŠ¨å¯åŠ¨ Docker Composeï¼ˆå¦‚æœç›´æ¥å®‰è£…çš„æœåŠ¡ä¸å¯ç”¨ï¼‰
- âœ… è¿è¡Œé›†æˆæµ‹è¯•
- âœ… æ”¶é›†æµ‹è¯•ç»“æœå’Œ Docker æ—¥å¿—
- âœ… æ¸…ç† Docker å®¹å™¨

**è¿è¡Œæ—¶é—´ï¼š** ~15-30 åˆ†é’Ÿ

**ç‰¹æ€§ï¼š**
- æ™ºèƒ½æ£€æµ‹ï¼šä¼˜å…ˆä½¿ç”¨ç›´æ¥å®‰è£…çš„æœåŠ¡ï¼Œå¦‚æœä¸å¯ç”¨åˆ™ä½¿ç”¨ Docker Compose
- å¤±è´¥æ—¶è‡ªåŠ¨æ”¶é›† Docker æ—¥å¿—

---

### 3. å®Œæ•´æµ‹è¯•å¥—ä»¶ (`full-test.yml`)

**è§¦å‘æ¡ä»¶ï¼š**
- æ¯å‘¨æ—¥å‡Œæ™¨ 3 ç‚¹è‡ªåŠ¨è¿è¡Œ
- æ‰‹åŠ¨è§¦å‘

**æ‰§è¡Œå†…å®¹ï¼š**
- âœ… å®Œå…¨æ¸…ç†å¹¶é‡å»º
- âœ… å¼ºåˆ¶ä½¿ç”¨ Docker Compose æœåŠ¡
- âœ… è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼ˆå•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯•ï¼‰
- âœ… ç”Ÿæˆå®Œæ•´æµ‹è¯•æŠ¥å‘Š
- âœ… æ”¶é›†æ‰€æœ‰æ—¥å¿—ï¼ˆDocker + ç³»ç»ŸæœåŠ¡ï¼‰

**è¿è¡Œæ—¶é—´ï¼š** ~30-60 åˆ†é’Ÿ

**ç‰¹æ€§ï¼š**
- æœ€ä¸¥æ ¼çš„æµ‹è¯•æµç¨‹
- å®Œæ•´çš„æ—¥å¿—æ”¶é›†å’Œå½’æ¡£ï¼ˆä¿ç•™ 14 å¤©ï¼‰

---

### 4. ä»£ç è´¨é‡æ£€æŸ¥ (`code-quality.yml`)

**è§¦å‘æ¡ä»¶ï¼š**
- Push åˆ° `main` æˆ– `develop` åˆ†æ”¯
- Pull Request åˆ° `main` æˆ– `develop` åˆ†æ”¯

**æ‰§è¡Œå†…å®¹ï¼š**
- âœ… ä»£ç é£æ ¼æ£€æŸ¥ï¼ˆCheckstyleï¼‰
- âœ… é™æ€åˆ†æ
- âœ… æ„å»ºéªŒè¯
- âœ… é¡¹ç›®ç»“æ„æ£€æŸ¥

**è¿è¡Œæ—¶é—´ï¼š** ~5-10 åˆ†é’Ÿ

---

## ä½¿ç”¨æŒ‡å—

### æŸ¥çœ‹å·¥ä½œæµè¿è¡ŒçŠ¶æ€

è®¿é—® GitHub ä»“åº“çš„ Actions é¡µé¢ï¼š
```
https://github.com/[ç”¨æˆ·å]/streaming/actions
```

### æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

1. è¿›å…¥ Actions é¡µé¢
2. é€‰æ‹© "Integration Tests" æˆ– "Full Test Suite"
3. ç‚¹å‡» "Run workflow" æŒ‰é’®
4. é€‰æ‹©åˆ†æ”¯å¹¶ç¡®è®¤

### æŸ¥çœ‹æµ‹è¯•ç»“æœ

1. è¿›å…¥å…·ä½“çš„å·¥ä½œæµè¿è¡Œé¡µé¢
2. æŸ¥çœ‹æ¯ä¸ªæ­¥éª¤çš„æ—¥å¿—è¾“å‡º
3. ä¸‹è½½ Artifactsï¼ˆæµ‹è¯•ç»“æœã€æ„å»ºäº§ç‰©ã€æ—¥å¿—æ–‡ä»¶ï¼‰

### Artifacts ä¿ç•™æ—¶é—´

- **å•å…ƒæµ‹è¯•ç»“æœ**: 7 å¤©
- **é›†æˆæµ‹è¯•ç»“æœ**: 7 å¤©
- **å®Œæ•´æµ‹è¯•ç»“æœ**: 14 å¤©
- **æ„å»ºäº§ç‰©**: 7 å¤©
- **Docker æ—¥å¿—**: 3 å¤©
- **ä»£ç è´¨é‡æŠ¥å‘Š**: 7 å¤©

---

## Self-Hosted Runner è¦æ±‚

### å¿…éœ€è½¯ä»¶
- **Java 17** (OpenJDK) - å¿…é¡»é¢„å…ˆå®‰è£…å¹¶é…ç½®åœ¨ PATH ä¸­
- **Gradle** (é€šè¿‡ wrapper è‡ªåŠ¨ä¸‹è½½)
- **Git**
- **Docker** (å¯é€‰ï¼Œå¦‚æœä½¿ç”¨ Docker Compose æ–¹å¼)

### å¯é€‰æœåŠ¡ï¼ˆäºŒé€‰ä¸€ï¼‰

#### é€‰é¡¹ 1ï¼šDocker Composeï¼ˆæ¨èï¼‰
- Redis
- MySQL
- PostgreSQL
- Elasticsearch

#### é€‰é¡¹ 2ï¼šç›´æ¥å®‰è£…
```bash
# å®‰è£…æœåŠ¡
sudo apt install -y redis-server mysql-server postgresql

# éªŒè¯å®‰è£…
./deploy/verify-services.sh
```

è¯¦ç»†é…ç½®æ­¥éª¤è¯·å‚è€ƒï¼š[docs/github-actions.md](../docs/github-actions.md)

---

## å·¥ä½œæµçŸ©é˜µ

| å·¥ä½œæµ | é¢‘ç‡ | æ—¶é•¿ | éœ€è¦æœåŠ¡ | å¤±è´¥å½±å“ |
|--------|------|------|----------|----------|
| Build | æ¯æ¬¡æäº¤ | 5-10åˆ†é’Ÿ | æ—  | ğŸ”´ é˜»æ­¢åˆå¹¶ |
| Integration Test | æ¯æ¬¡æäº¤ + æ¯æ—¥ | 15-30åˆ†é’Ÿ | Redis, MySQL | ğŸ”´ é˜»æ­¢åˆå¹¶ |
| Full Test | æ¯å‘¨ | 30-60åˆ†é’Ÿ | å…¨éƒ¨ | ğŸŸ¡ è­¦å‘Š |
| Code Quality | æ¯æ¬¡æäº¤ | 5-10åˆ†é’Ÿ | æ—  | ğŸŸ¡ è­¦å‘Š |

---

## å·¥ä½œæµä¼˜åŒ–è¯´æ˜

### ä½¿ç”¨ç³»ç»Ÿ Java è€Œé actions/setup-java

æ‰€æœ‰å·¥ä½œæµå·²ä¼˜åŒ–ä¸º**ç›´æ¥ä½¿ç”¨ Runner æœåŠ¡å™¨ä¸Šé¢„è£…çš„ Java 17**ï¼Œè€Œä¸æ˜¯æ¯æ¬¡éƒ½é€šè¿‡ `actions/setup-java` ä¸‹è½½ã€‚

**ä¼˜åŠ¿ï¼š**
- âš¡ **æ›´å¿«çš„å¯åŠ¨æ—¶é—´** - è·³è¿‡ Java ä¸‹è½½å’Œè®¾ç½®æ­¥éª¤
- ğŸ’¾ **èŠ‚çœç£ç›˜ç©ºé—´** - ä¸éœ€è¦ç¼“å­˜å¤šä¸ª Java ç‰ˆæœ¬
- ğŸ”§ **ç®€åŒ–é…ç½®** - åªéœ€åœ¨æœåŠ¡å™¨ä¸Šå®‰è£…ä¸€æ¬¡ Java

**å‰ææ¡ä»¶ï¼š**
Runner æœåŠ¡å™¨å¿…é¡»é¢„å…ˆå®‰è£… Java 17ï¼š
```bash
# å®‰è£… Java 17
sudo apt install -y openjdk-17-jdk

# éªŒè¯å®‰è£…
java -version
# åº”è¯¥æ˜¾ç¤º: openjdk version "17.x.x"

# è®¾ç½® JAVA_HOMEï¼ˆå¦‚æœéœ€è¦ï¼‰
export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
echo 'export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64' >> ~/.bashrc
```

å·¥ä½œæµä¼šåœ¨è¿è¡Œæ—¶éªŒè¯ Java ç‰ˆæœ¬ï¼š
```yaml
- name: Verify Java version
  run: |
    java -version
    echo "JAVA_HOME=$JAVA_HOME"
```

å¦‚æœéœ€è¦æ¢å¤ä½¿ç”¨ `actions/setup-java`ï¼ˆä¾‹å¦‚åœ¨ GitHub æ‰˜ç®¡çš„ runner ä¸Šè¿è¡Œï¼‰ï¼Œå¯ä»¥å–æ¶ˆæ³¨é‡Šç›¸å…³é…ç½®ã€‚

---

## æ•…éšœæ’æŸ¥

### å·¥ä½œæµå¤±è´¥å¸¸è§åŸå› 

#### 1. æœåŠ¡è¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
./deploy/verify-services.sh

# é‡å¯æœåŠ¡
docker compose restart
# æˆ–
sudo systemctl restart redis-server mysql
```

#### 2. ç«¯å£å†²çª
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tlnp | grep -E '6379|3306|5432'
```

#### 3. ç£ç›˜ç©ºé—´ä¸è¶³
```bash
# æ¸…ç† Docker
docker system prune -a --volumes

# æ¸…ç† Gradle ç¼“å­˜
./gradlew clean
rm -rf ~/.gradle/caches/
```

#### 4. æƒé™é—®é¢˜
```bash
# ç¡®è®¤ runner ç”¨æˆ·åœ¨ docker ç»„
groups runner

# æ·»åŠ åˆ° docker ç»„
sudo usermod -aG docker runner
```

---

## æœ€ä½³å®è·µ

### 1. åˆ†æ”¯ä¿æŠ¤è§„åˆ™

å»ºè®®åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­é…ç½®ï¼š

**main åˆ†æ”¯ï¼š**
- âœ… è¦æ±‚ "Build" å·¥ä½œæµé€šè¿‡
- âœ… è¦æ±‚ "Integration Tests" å·¥ä½œæµé€šè¿‡
- âœ… è¦æ±‚è‡³å°‘ 1 ä¸ªå®¡æ ¸é€šè¿‡
- âœ… è¦æ±‚åˆ†æ”¯ä¸ºæœ€æ–°

**develop åˆ†æ”¯ï¼š**
- âœ… è¦æ±‚ "Build" å·¥ä½œæµé€šè¿‡
- âœ… å¯é€‰ï¼šè¦æ±‚ "Integration Tests" å·¥ä½œæµé€šè¿‡

### 2. ç›‘æ§å»ºè®®

è®¾ç½® GitHub é€šçŸ¥ï¼š
- å·¥ä½œæµå¤±è´¥æ—¶å‘é€é‚®ä»¶
- PR çŠ¶æ€æ£€æŸ¥å¤±è´¥æ—¶é€šçŸ¥

### 3. èµ„æºä¼˜åŒ–

```bash
# Runner æœåŠ¡å™¨å®šæœŸæ¸…ç†ï¼ˆæ·»åŠ åˆ° crontabï¼‰
0 4 * * * docker system prune -f >> /home/runner/cleanup.log 2>&1
0 4 * * 0 rm -rf ~/.gradle/caches/modules-2/ >> /home/runner/cleanup.log 2>&1
```

---

## æ‰©å±•é…ç½®

### æ·»åŠ æ–°çš„å·¥ä½œæµ

1. åœ¨ `.github/workflows/` ç›®å½•åˆ›å»ºæ–°çš„ YAML æ–‡ä»¶
2. ä½¿ç”¨ `runs-on: self-hosted` æŒ‡å®š runner
3. æ·»åŠ å¿…è¦çš„æ­¥éª¤å’Œæ£€æŸ¥
4. æäº¤å¹¶æ¨é€åˆ°ä»“åº“

### ç¤ºä¾‹ï¼šå‘å¸ƒå·¥ä½œæµ

```yaml
name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Build release
        run: ./gradlew build -x test
      - name: Create GitHub release
        uses: actions/create-release@v1
        # ... æ›´å¤šæ­¥éª¤
```

---

## å‚è€ƒèµ„æ–™

- [GitHub Actions å®˜æ–¹æ–‡æ¡£](https://docs.github.com/en/actions)
- [Self-Hosted Runner é…ç½®](../docs/github-actions.md)
- [é¡¹ç›®æ„å»ºè¯´æ˜](../CLAUDE.md)
