name: Tests
on: [push, pull_request]

permissions:
  contents: read
  checks: write
  pull-requests: write
  actions: read

jobs:
  test:
    runs-on: self-hosted
    timeout-minutes: 45
    concurrency:
      group: tests-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - uses: actions/checkout@v4

      - name: Verify Java version
        run: |
          java -version
          echo "JAVA_HOME=$JAVA_HOME"

      - name: Assert Java 17
        run: |
          MAJOR=$(java -version 2>&1 | awk -F[".] '/version/ {print $2}')
          echo "Detected Java major: $MAJOR"
          if [ "$MAJOR" != "17" ]; then
            echo "âŒ Expected Java 17 but found: $(java -version 2>&1 | head -n 1)"
            exit 1
          fi

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # Change detection removed: always run full integration tests

      - name: Setup Docker permissions
        run: |
          # æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦åœ¨ docker ç»„ä¸­
          if ! groups $USER | grep -q docker; then
            echo "âŒ User $USER is not in docker group"
            echo "Please run on your runner: sudo usermod -aG docker $USER"
            echo "Then restart the runner service: sudo systemctl restart actions.runner.*"
            exit 1
          fi

          # éªŒè¯ Docker è®¿é—®æƒé™
          if ! docker ps >/dev/null 2>&1; then
            echo "âŒ Cannot access Docker daemon"
            echo "Please ensure Docker is running and user has proper permissions"
            exit 1
          fi

          echo "âœ… Docker permissions OK"

      - name: Start test environment
        run: |
          # æ¸…ç†å¯èƒ½å­˜åœ¨çš„å®¹å™¨å’Œç½‘ç»œ
          docker compose -f docker-compose.minimal.yml down -v --remove-orphans 2>/dev/null || true

          # å¯åŠ¨æµ‹è¯•çŽ¯å¢ƒ
          echo "Starting test environment..."
          echo "Start full minimal stack (redis/mysql/postgres)"
          docker compose -f docker-compose.minimal.yml up -d

          # ç­‰å¾…æ‰€æœ‰æœåŠ¡å¥åº·
          echo "Waiting for services to be healthy..."
          timeout 300 bash -c '
            for service in redis mysql postgres; do
              echo "Waiting for $service..."
              until docker compose -f docker-compose.minimal.yml ps $service | grep -q "healthy\|Up"; do
                sleep 2
              done
              echo "$service is ready"
            done
          '

      - name: Verify services connectivity
        run: |
          echo "Verifying services are accessible from host..."

          # éªŒè¯ç«¯å£æ˜¯å¦å¯è¾¾ï¼ˆæœåŠ¡å·²é€šè¿‡ç«¯å£æ˜ å°„æš´éœ²åˆ°å®¿ä¸»æœºï¼‰
          echo "Checking Redis (6379)..."
          timeout 30 bash -c 'until nc -z localhost 6379; do sleep 1; done'

          echo "Checking MySQL (3306)..."
          timeout 30 bash -c 'until nc -z localhost 3306; do sleep 1; done'

          echo "Checking PostgreSQL (5432)..."
          timeout 30 bash -c 'until nc -z localhost 5432; do sleep 1; done'

          echo "All service ports are accessible!"

      - name: Run unit tests
        run: ./gradlew test --parallel --continue --console=plain
        timeout-minutes: 15

      - name: Run integration tests
        run: ./gradlew integrationTest --continue --info --stacktrace
        timeout-minutes: 25
        env:
          REDIS_URL: redis://localhost:6379
          MYSQL_URL: jdbc:mysql://localhost:3306/test_db
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_password
          POSTGRES_URL: jdbc:postgresql://localhost:5432/test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password

      - name: Publish test results
        if: always()
        run: |
          echo "ðŸ“Š Test Results Summary:"
          echo "=================================="

          # Count test results
          UNIT_TESTS=$(find . -name "TEST-*.xml" -path "*/test-results/test/*" | wc -l)
          INTEGRATION_TESTS=$(find . -name "TEST-*.xml" -path "*/test-results/integrationTest/*" | wc -l)

          echo "Unit test files found: $UNIT_TESTS"
          echo "Integration test files found: $INTEGRATION_TESTS"

          # Check for failures in test XML files
          FAILED_TESTS=$(find . -name "TEST-*.xml" -exec grep -l 'failures="[1-9]' {} \; 2>/dev/null | head -5)
          ERROR_TESTS=$(find . -name "TEST-*.xml" -exec grep -l 'errors="[1-9]' {} \; 2>/dev/null | head -5)

          if [ -n "$FAILED_TESTS" ] || [ -n "$ERROR_TESTS" ]; then
            echo "âŒ Test failures detected:"

            if [ -n "$FAILED_TESTS" ]; then
              echo "Files with failures:"
              echo "$FAILED_TESTS"
            fi

            if [ -n "$ERROR_TESTS" ]; then
              echo "Files with errors:"
              echo "$ERROR_TESTS"
            fi

            # Show detailed failure info
            echo ""
            echo "Detailed failure information:"
            find . -name "TEST-*.xml" -exec grep -l 'failures="[1-9]\|errors="[1-9]' {} \; | head -3 | while read file; do
              echo "=== Failures in $file ==="
              grep -A 5 -B 5 'failure\|error' "$file" || true
              echo ""
            done

            exit 1
          else
            echo "âœ… All tests passed!"
          fi

      - name: Upload integration test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            **/build/test-results/integrationTest/
            **/build/reports/tests/integrationTest/
          retention-days: 7

      - name: Collect Docker logs
        if: always()
        run: |
          mkdir -p docker-logs
          # collect logs per running service in this compose
          for s in redis mysql postgres; do
            if docker compose -f docker-compose.minimal.yml ps $s >/dev/null 2>&1; then
              docker compose -f docker-compose.minimal.yml logs $s > docker-logs/$s.log 2>&1 || true
            fi
          done

      - name: Upload Docker logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docker-logs
          path: docker-logs/
          retention-days: 3

      - name: Cleanup test environment
        if: always()
        run: |
          echo "Cleaning up test environment..."
          docker compose -f docker-compose.minimal.yml down -v --remove-orphans

      - name: Cleanup Gradle Cache
        if: always()
        run: |
          rm -f ~/.gradle/caches/modules-2/modules-2.lock
          rm -f ~/.gradle/caches/modules-2/gc.properties
