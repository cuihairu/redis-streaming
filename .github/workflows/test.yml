name: Tests
on: [push, pull_request]

permissions:
  contents: read
  checks: write
  pull-requests: write
  actions: read

jobs:
  test:
    runs-on: self-hosted
    timeout-minutes: 45

    steps:
      - name: Cleanup workspace
        run: |
          rm -rf ${{ github.workspace }}/*
          rm -rf ${{ github.workspace }}/.* 2>/dev/null || true

      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Setup Docker permissions
        run: |
          # Ê£ÄÊü•ÂΩìÂâçÁî®Êà∑ÊòØÂê¶Âú® docker ÁªÑ‰∏≠
          if ! groups $USER | grep -q docker; then
            echo "‚ùå User $USER is not in docker group"
            echo "Please run on your runner: sudo usermod -aG docker $USER"
            echo "Then restart the runner service: sudo systemctl restart actions.runner.*"
            exit 1
          fi

          # È™åËØÅ Docker ËÆøÈóÆÊùÉÈôê
          if ! docker ps >/dev/null 2>&1; then
            echo "‚ùå Cannot access Docker daemon"
            echo "Please ensure Docker is running and user has proper permissions"
            exit 1
          fi

          echo "‚úÖ Docker permissions OK"

      - name: Start test environment
        run: |
          # Ê∏ÖÁêÜÂèØËÉΩÂ≠òÂú®ÁöÑÂÆπÂô®ÂíåÁΩëÁªú
          docker compose -f docker-compose.minimal.yml down -v --remove-orphans 2>/dev/null || true
          docker system prune -f

          # ÂêØÂä®ÊµãËØïÁéØÂ¢É
          echo "Starting test environment..."
          docker compose -f docker-compose.minimal.yml up -d

          # Á≠âÂæÖÊâÄÊúâÊúçÂä°ÂÅ•Â∫∑
          echo "Waiting for services to be healthy..."
          timeout 300 bash -c '
            services="redis mysql postgres"
            for service in $services; do
              echo "Waiting for $service..."
              until docker compose -f docker-compose.minimal.yml ps $service | grep -q "healthy\|Up"; do
                sleep 2
              done
              echo "$service is ready"
            done
          '

      - name: Verify services connectivity
        run: |
          echo "Verifying services are accessible from host..."

          # È™åËØÅÁ´ØÂè£ÊòØÂê¶ÂèØËææÔºàÊúçÂä°Â∑≤ÈÄöËøáÁ´ØÂè£Êò†Â∞ÑÊö¥Èú≤Âà∞ÂÆø‰∏ªÊú∫Ôºâ
          echo "Checking Redis (6379)..."
          timeout 30 bash -c 'until nc -z localhost 6379; do sleep 1; done'

          echo "Checking MySQL (3306)..."
          timeout 30 bash -c 'until nc -z localhost 3306; do sleep 1; done'

          echo "Checking PostgreSQL (5432)..."
          timeout 30 bash -c 'until nc -z localhost 5432; do sleep 1; done'

          echo "All service ports are accessible!"

      - name: Run unit tests
        run: ./gradlew test --parallel --continue
        timeout-minutes: 15

      - name: Run integration tests
        run: ./gradlew integrationTest --continue
        timeout-minutes: 20
        env:
          REDIS_URL: redis://localhost:6379
          MYSQL_URL: jdbc:mysql://localhost:3306/test_db
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_password
          POSTGRES_URL: jdbc:postgresql://localhost:5432/test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password

      - name: Publish test results
        if: always()
        run: |
          echo "üìä Test Results Summary:"
          echo "=================================="

          # Count test results
          UNIT_TESTS=$(find . -name "TEST-*.xml" -path "*/test-results/test/*" | wc -l)
          INTEGRATION_TESTS=$(find . -name "TEST-*.xml" -path "*/test-results/integrationTest/*" | wc -l)

          echo "Unit test files found: $UNIT_TESTS"
          echo "Integration test files found: $INTEGRATION_TESTS"

          # Check for failures in test XML files
          FAILED_TESTS=$(find . -name "TEST-*.xml" -exec grep -l 'failures="[1-9]' {} \; 2>/dev/null | head -5)
          ERROR_TESTS=$(find . -name "TEST-*.xml" -exec grep -l 'errors="[1-9]' {} \; 2>/dev/null | head -5)

          if [ -n "$FAILED_TESTS" ] || [ -n "$ERROR_TESTS" ]; then
            echo "‚ùå Test failures detected:"

            if [ -n "$FAILED_TESTS" ]; then
              echo "Files with failures:"
              echo "$FAILED_TESTS"
            fi

            if [ -n "$ERROR_TESTS" ]; then
              echo "Files with errors:"
              echo "$ERROR_TESTS"
            fi

            # Show detailed failure info
            echo ""
            echo "Detailed failure information:"
            find . -name "TEST-*.xml" -exec grep -l 'failures="[1-9]\|errors="[1-9]' {} \; | head -3 | while read file; do
              echo "=== Failures in $file ==="
              grep -A 5 -B 5 'failure\|error' "$file" || true
              echo ""
            done

            exit 1
          else
            echo "‚úÖ All tests passed!"
          fi

      - name: Cleanup test environment
        if: always()
        run: |
          echo "Cleaning up test environment..."
          docker compose -f docker-compose.minimal.yml down -v --remove-orphans
          docker system prune -f

      - name: Cleanup Gradle Cache
        if: always()
        run: |
          rm -f ~/.gradle/caches/modules-2/modules-2.lock
          rm -f ~/.gradle/caches/modules-2/gc.properties