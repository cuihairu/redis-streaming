name: Tests
on: [push, pull_request]

permissions:
  contents: read
  checks: write
  pull-requests: write
  actions: read

jobs:
  test:
    runs-on: self-hosted
    timeout-minutes: 45

    steps:
      - name: Cleanup workspace
        run: |
          rm -rf ${{ github.workspace }}/*
          rm -rf ${{ github.workspace }}/.* 2>/dev/null || true

      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Setup Docker permissions
        run: |
          # æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦åœ¨ docker ç»„ä¸­
          if ! groups $USER | grep -q docker; then
            echo "âŒ User $USER is not in docker group"
            echo "Please run on your runner: sudo usermod -aG docker $USER"
            echo "Then restart the runner service: sudo systemctl restart actions.runner.*"
            exit 1
          fi

          # éªŒè¯ Docker è®¿é—®æƒé™
          if ! docker ps >/dev/null 2>&1; then
            echo "âŒ Cannot access Docker daemon"
            echo "Please ensure Docker is running and user has proper permissions"
            exit 1
          fi

          echo "âœ… Docker permissions OK"

      - name: Start test environment
        run: |
          # æ¸…ç†å¯èƒ½å­˜åœ¨çš„å®¹å™¨å’Œç½‘ç»œ
          docker compose -f docker-compose.minimal.yml down -v --remove-orphans 2>/dev/null || true
          docker system prune -f

          # å¯åŠ¨æµ‹è¯•ç¯å¢ƒ
          echo "Starting test environment..."
          docker compose -f docker-compose.minimal.yml up -d

          # ç­‰å¾…æ‰€æœ‰æœåŠ¡å¥åº·
          echo "Waiting for services to be healthy..."
          timeout 300 bash -c '
            services="redis mysql postgres"
            for service in $services; do
              echo "Waiting for $service..."
              until docker compose -f docker-compose.minimal.yml ps $service | grep -q "healthy\|Up"; do
                sleep 2
              done
              echo "$service is ready"
            done
          '

      - name: Verify services connectivity
        run: |
          echo "Verifying services are accessible from host..."

          # éªŒè¯ç«¯å£æ˜¯å¦å¯è¾¾ï¼ˆæœåŠ¡å·²é€šè¿‡ç«¯å£æ˜ å°„æš´éœ²åˆ°å®¿ä¸»æœºï¼‰
          echo "Checking Redis (6379)..."
          timeout 30 bash -c 'until nc -z localhost 6379; do sleep 1; done'

          echo "Checking MySQL (3306)..."
          timeout 30 bash -c 'until nc -z localhost 3306; do sleep 1; done'

          echo "Checking PostgreSQL (5432)..."
          timeout 30 bash -c 'until nc -z localhost 5432; do sleep 1; done'

          echo "All service ports are accessible!"

      - name: Run unit tests
        run: ./gradlew test --parallel --continue
        timeout-minutes: 15

      - name: Run integration tests
        run: ./gradlew integrationTest --continue
        timeout-minutes: 20
        env:
          REDIS_URL: redis://localhost:6379
          MYSQL_URL: jdbc:mysql://localhost:3306/test_db
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_password
          POSTGRES_URL: jdbc:postgresql://localhost:5432/test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password

      - name: Publish test results
        if: always()
        run: |
          echo "ğŸ“Š Test Results Summary:"
          echo "=================================="

          # Count test results
          UNIT_TESTS=$(find . -name "TEST-*.xml" -path "*/test-results/test/*" | wc -l)
          INTEGRATION_TESTS=$(find . -name "TEST-*.xml" -path "*/test-results/integrationTest/*" | wc -l)

          echo "Unit test files found: $UNIT_TESTS"
          echo "Integration test files found: $INTEGRATION_TESTS"

          # Show failed tests if any
          if find . -name "TEST-*.xml" -exec grep -l 'failures="[^0]"' {} \; | head -5; then
            echo "âŒ Some tests failed - check logs above"
            exit 1
          else
            echo "âœ… All tests passed!"
          fi

      - name: Cleanup test environment
        if: always()
        run: |
          echo "Cleaning up test environment..."
          docker compose -f docker-compose.minimal.yml down -v --remove-orphans
          docker system prune -f

      - name: Cleanup Gradle Cache
        if: always()
        run: |
          rm -f ~/.gradle/caches/modules-2/modules-2.lock
          rm -f ~/.gradle/caches/modules-2/gc.properties